<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spracherkennung mit Arduino BLE</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        h1 {
            color: #1c1e21;
            text-align: center;
        }
        
        .control-section {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #connectButton {
            font-size: 1.1rem;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #connectButton:hover {
            background-color: #218838;
        }

        #connectButton:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #btStatus {
            margin-top: 10px;
            font-weight: bold;
        }

        #outputContainer {
            margin-top: 10px;
            text-align: center;
            min-height: 50px;
        }

        #outputText {
            font-size: 1.8rem;
            font-weight: bold;
            color: #555;
            padding: 15px 25px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            min-width: 250px;
            display: inline-block;
        }

        #visualIndicator {
            width: 100px;
            height: 100px;
            margin-top: 20px;
            background-color: #e9ecef;
            border: 2px solid #ced4da;
            border-radius: 50%;
            transition: background-color 0.4s, transform 0.4s;
        }
    </style>
</head>
<body>

    <h1>Spracherkennung & Arduino Steuerung</h1>

    <div class="control-section">
        <button id="connectButton">Mit Arduino verbinden</button>
        <p id="btStatus">Status: Nicht verbunden</p>
    </div>

    <div id="outputContainer">
        <p>Zuletzt erkannte gültige Zahl:</p>
        <span id="outputText">Warte auf Eingabe...</span>
    </div>

    <div id="visualIndicator"></div>

    <script>
        // --- DOM Elemente ---
        const connectButton = document.getElementById('connectButton');
        const btStatus = document.getElementById('btStatus');
        const outputText = document.getElementById('outputText');
        const visualIndicator = document.getElementById('visualIndicator');

        // --- Web Bluetooth Code ---
        let arduinoDevice;
        let arduinoServer;
        let arduinoUartService;
        let arduinoUartCharacteristic;

        const ARDUINO_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const ARDUINO_UART_WRITE_CHARACTERISTIC_CANDIDATES = [
            '6e400002-b5a3-f393-e0a9-e50e24dcca9e', // Standard-Nordic RX (Central → Peripheral)
            '6e400003-b5a3-f393-e0a9-e50e24dcca9e'  // Fallback für Boards, die auf TX schreiben lassen
        ];
        const ARDUINO_NAME_PREFIXES = ['Arduino UNO R4', 'UNO R4', 'Arduino UNO'];

        function buildArduinoFilters() {
            const filters = ARDUINO_NAME_PREFIXES.map((prefix) => ({
                namePrefix: prefix,
                services: [ARDUINO_UART_SERVICE_UUID]
            }));
            filters.push({ services: [ARDUINO_UART_SERVICE_UUID] });
            return filters;
        }

        async function connectArduino() {
            try {
                arduinoDevice = await navigator.bluetooth.requestDevice({
                    filters: buildArduinoFilters(),
                    optionalServices: [ARDUINO_UART_SERVICE_UUID]
                });

                arduinoServer = await arduinoDevice.gatt.connect();
                arduinoUartService = await arduinoServer.getPrimaryService(ARDUINO_UART_SERVICE_UUID);
                arduinoUartCharacteristic = await findArduinoCharacteristic(arduinoUartService);

                console.log('✅ Arduino UNO R4 verbunden');
                alert('Arduino UNO R4 erfolgreich verbunden!');
                setBluetoothConnected(true);

                arduinoDevice.addEventListener('gattserverdisconnected', handleArduinoDisconnect);
            } catch (error) {
                console.error('❌ Fehler beim Verbinden mit dem Arduino UNO R4:', error);
                alert('Arduino UNO R4 konnte nicht verbunden werden. Bitte prüfe den Bluetooth-Status und das laufende Sketch.');
                cleanupArduinoState();
                setBluetoothConnected(false);
            }
        }

        function handleArduinoDisconnect() {
            console.warn('⚠️ Arduino UNO R4 Verbindung getrennt.');
            alert('Arduino UNO R4 Verbindung getrennt.');
            cleanupArduinoState();
            setBluetoothConnected(false);
        }

        function cleanupArduinoState() {
            arduinoUartCharacteristic = null;
            arduinoUartService = null;
            if (arduinoServer && arduinoServer.connected) {
                arduinoServer.disconnect();
            }
            arduinoServer = null;
            arduinoDevice = null;
        }

        async function findArduinoCharacteristic(service) {
            for (const uuid of ARDUINO_UART_WRITE_CHARACTERISTIC_CANDIDATES) {
                try {
                    return await service.getCharacteristic(uuid);
                } catch (_) {
                    // continue searching
                }
            }
            throw new Error('Kein kompatibles UART-Charakteristikum im UNO R4 Service gefunden.');
        }

        async function sendToArduino(text) {
            if (!arduinoUartCharacteristic) {
                console.warn('Arduino UNO R4 ist nicht verbunden – Nachricht wurde nicht gesendet.');
                return;
            }

            try {
                const data = new TextEncoder().encode(String(text) + '\n');
                await arduinoUartCharacteristic.writeValueWithoutResponse(data);
                console.log(`Gesendet: ${text}`);
            } catch (error) {
                console.error('Senden zum Arduino UNO R4 fehlgeschlagen:', error);
            }
        }

        function setBluetoothConnected(isConnected) {
            if (isConnected) {
                btStatus.textContent = 'Status: Verbunden';
                btStatus.style.color = '#28a745';
                connectButton.textContent = 'Trennen';
                connectButton.onclick = handleArduinoDisconnect;
            } else {
                btStatus.textContent = 'Status: Nicht verbunden';
                btStatus.style.color = '#dc3545';
                connectButton.textContent = 'Mit Arduino verbinden';
                connectButton.onclick = connectArduino;
            }
        }

        // Initialer Setup für den Bluetooth-Button
        if ('bluetooth' in navigator) {
            connectButton.onclick = connectArduino;
        } else {
            connectButton.disabled = true;
            btStatus.textContent = 'Web Bluetooth wird von diesem Browser nicht unterstützt.';
            alert('Web Bluetooth wird von diesem Browser nicht unterstützt. Bitte nutze Chrome auf Desktop oder Android.');
        }

        // --- Web Speech API Code ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const validNumbers = {
            'null': '#6c757d', 'eins': '#dc3545', 'zwei': '#fd7e14', 'drei': '#ffc107',
            'vier': '#28a745', 'fünf': '#20c997', 'sechs': '#17a2b8', 'sieben': '#007bff',
            'acht': '#6610f2', 'neun': '#e83e8c'
        };
        // Map für die Umwandlung von Wort zu Ziffer
        const numberMap = {
            'null': '0', 'eins': '1', 'zwei': '2', 'drei': '3', 'vier': '4', 
            'fünf': '5', 'sechs': '6', 'sieben': '7', 'acht': '8', 'neun': '9'
        };

        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'de-DE';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const speechResult = event.results[i][0].transcript.toLowerCase().trim().replace('.', '');
                        console.log('Vollständiges Ergebnis:', speechResult);

                        // Teile das Ergebnis in einzelne Wörter auf und suche nach einem gültigen Zahlwort
                        const words = speechResult.split(' ');
                        const foundNumberWord = words.find(word => validNumbers.hasOwnProperty(word));

                        if (foundNumberWord) {
                            console.log('Gültiges Zahlwort gefunden:', foundNumberWord);
                            outputText.textContent = foundNumberWord;
                            visualIndicator.style.backgroundColor = validNumbers[foundNumberWord];
                            visualIndicator.style.transform = 'scale(1.2)';
                            
                            // Wandle das gefundene Wort in die entsprechende Ziffer um
                            const numberToSend = numberMap[foundNumberWord];
                            
                            // Sende die Ziffer an den Arduino
                            sendToArduino(numberToSend);
                        }
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('Fehler bei der Spracherkennung:', event.error);
            };
            
            recognition.onend = () => {
                console.log('Spracherkennung beendet, starte neu.');
                recognition.start();
            };
            
            recognition.start();

        } else {
            outputText.textContent = 'Browser nicht unterstützt';
            alert('Dein Browser unterstützt die Web Speech API nicht.');
        }
    </script>

</body>
</html>
